"""
Updated Details Manager with enhanced export functionality
"""

import tkinter as tk
from tkinter import filedialog, messagebox
import logging
import os
from pathlib import Path
from export_manager import ExportManager


class DetailsManager:
    """Manages the details panel and export functionality"""

    def __init__(self, details_text, logger=None):
        self.details_text = details_text
        self.logger = logger or logging.getLogger(__name__)
        self.json_data = None
        self.export_manager = ExportManager(logger)
        self.current_item_data = None

    def set_json_data(self, json_data):
        """Set the JSON data for export reference"""
        self.json_data = json_data

    def show_item_details(self, item, tree):
        """Show details of selected item"""
        self.clear_details()

        try:
            item_id = item['id']
            item_text = item['text']
            item_tags = item['tags']

            self.details_text.insert(tk.END, f"Name: {item_text}\n")
            self.details_text.insert(tk.END, f"Type: {', '.join(item_tags)}\n")
            self.details_text.insert(tk.END, "-" * 50 + "\n\n")

            # Store current item data for export
            self.current_item_data = self._extract_item_data(item_id, item_tags)

            if self.current_item_data:
                self._display_formatted_details(self.current_item_data)
            else:
                self.details_text.insert(tk.END, "No detailed information available.\n")

        except Exception as e:
            self.logger.error(f"Error showing details: {str(e)}")
            self.details_text.insert(tk.END, f"Error: {str(e)}\n")

    def _extract_item_data(self, item_id, tags):
        """Extract detailed data for the item"""
        if not self.json_data:
            return None

        # Determine item type and find in JSON data
        for tag in tags:
            if tag in ['datatype', 'pou', 'enum', 'union', 'structure', 'globalvar']:
                section = self._get_section_from_tag(tag)
                if section in self.json_data:
                    # Extract just the item name from the ID (remove any prefixes)
                    item_name = item_id
                    if '_' in item_id:
                        # Try to find the actual item name
                        parts = item_id.split('_')
                        # The last part is often the actual name
                        possible_name = parts[-1]

                        # Search for exact match first
                        for item in self.json_data[section]:
                            if item.get('name') == item_name:
                                return item

                        # Then try the last part
                        for item in self.json_data[section]:
                            if item.get('name') == possible_name:
                                return item

                        # Finally, search for partial match
                        for item in self.json_data[section]:
                            if possible_name in item.get('name', ''):
                                return item
                    else:
                        # Simple name match
                        for item in self.json_data[section]:
                            if item.get('name') == item_name:
                                return item
        return None

    def _get_section_from_tag(self, tag):
        """Map tag to JSON section name"""
        mapping = {
            'datatype': 'data_types',
            'pou': 'pous',
            'enum': 'enums',
            'union': 'unions',
            'structure': 'structures',
            'globalvar': 'global_variables'
        }
        return mapping.get(tag, tag)

    def _display_formatted_details(self, data):
        """Display formatted details in the text widget"""
        # Display common fields
        if 'description' in data:
            self.details_text.insert(tk.END, f"Description: {data['description']}\n\n")

        # Type-specific formatting
        if 'base_type' in data:
            self.details_text.insert(tk.END, f"Base Type: {data['base_type']}\n")

        if 'initial_value' in data:
            self.details_text.insert(tk.END, f"Initial Value: {data['initial_value']}\n")

        if 'pou_type' in data:
            self.details_text.insert(tk.END, f"POU Type: {data['pou_type']}\n")

        if 'return_type' in data:
            self.details_text.insert(tk.END, f"Return Type: {data['return_type']}\n")

        # Display members/values/variables
        if 'members' in data:
            self.details_text.insert(tk.END, "\nMembers:\n")
            for member in data['members']:
                self.details_text.insert(tk.END, f"  {member.get('name')}: {member.get('type')}\n")
                if 'initial_value' in member:
                    self.details_text.insert(tk.END, f"    Initial: {member['initial_value']}\n")

        if 'values' in data:
            self.details_text.insert(tk.END, "\nValues:\n")
            for value in data['values']:
                self.details_text.insert(tk.END, f"  {value.get('name')} = {value.get('value')}\n")

        if 'variables' in data:
            self.details_text.insert(tk.END, "\nVariables:\n")
            for var in data['variables']:
                self.details_text.insert(tk.END, f"  {var.get('name')}: {var.get('type')}\n")

        # Display implementation if present
        if 'implementation' in data:
            self.details_text.insert(tk.END, "\nImplementation:\n")
            self.details_text.insert(tk.END, "=" * 50 + "\n")
            self.details_text.insert(tk.END, data['implementation'] + "\n")
            self.details_text.insert(tk.END, "=" * 50 + "\n")

    def clear_details(self):
        """Clear the details text widget"""
        self.details_text.delete('1.0', tk.END)

    def export_item_structure(self, item_name, item_type, format='text'):
        """Export the current item structure"""
        if not self.current_item_data:
            messagebox.showwarning("Warning", "No item data available to export.")
            return None

        try:
            # Set source file if available
            if hasattr(self, 'source_file'):
                self.export_manager.source_file = self.source_file

            # Export the item
            filepath = self.export_manager.export_item(
                item_name=item_name,
                item_type=item_type,
                item_data=self.current_item_data,
                format=format
            )

            return filepath

        except Exception as e:
            self.logger.error(f"Export failed: {str(e)}", exc_info=True)
            messagebox.showerror("Export Error", f"Export failed: {str(e)}")
            return None